# 频段解耦视角下的多密钥正交性分析

> **负责人**：成员 B  
> **角色**：挑战者 (The Challenger)  
> **核心贡献**：频段编码的密钥正交性分析 + 容量极限探索

---

## 1. 研究动机

### 1.1 与项目主题的关联

本项目的核心主题是 **“基于频段解耦的生成式水印技术测评与优化”**。成员 A 从“鲁棒性”角度探索了不同频段的水印注入策略，而本研究从 **“可识别性”** 角度，分析频域编码如何实现多密钥区分。

**频段解耦的两个维度**：

| 维度 | 负责人 | 研究问题 |
|------|--------|----------|
| **鲁棒性** | 成员 A | 不同频段的水印如何抵抗攻击？ |
| **可识别性** | 成员 B | 不同频段的编码如何实现密钥区分？ |

### 1.2 问题提出

传统的 Tree-Ring 水印方案只能回答一个简单的二元问题：“这张图片是否包含水印？”。然而，在多供应商场景中，我们需要回答：

> **“这张图片是由哪个供应商生成的？”**

RingID 通过在傅里叶频域的 **不同半径环**（即不同频段）上编码不同的值，实现多密钥区分。这与我们项目的“频段解耦”主题直接相关。

### 1.3 研究目标

本研究从频段解耦的视角，全面评估 RingID 的多密钥识别能力：

1. **密钥正交性分析**：验证不同频段编码的密钥间干扰程度
2. **容量极限探索** 🌟：探索频段编码容量与识别准确率的权衡关系

---

## 2. 技术方案

### 2.1 频段编码与密钥区分原理

RingID 的核心思想是利用傅里叶频域的 **不同半径环**（对应不同频段）进行密钥编码。这与成员 A 研究的“双频带策略”形成互补：

| 研究 | 频段使用方式 | 目标 |
|------|--------------|------|
| 成员 A | 低频 vs 高频 vs 双频带 | 提升鲁棒性 |
| 成员 B | 11 个频段的组合编码 | 实现多密钥区分 |

```
频段编码示意图：

        ┌───────────────────┐
        │    ○ ○ ○ ○ ○    │  ← 高频段 (R=14)
        │  ○           ○  │
        │ ○     ●●●     ○ │  ← 低频段 (R=3)
        │  ○           ○  │
        │    ○ ○ ○ ○ ○    │
        └───────────────────┘
        
        编码区域: 11 个同心环 (R=3 到 R=14)
        每个环 = 1 个频段 = 1 个编码位
        理论密钥容量: K^11
```

**频段编码的物理意义**：
- **低频环** (R=3-7)：对应图像的低频分量，抵抗压缩攻击能力强
- **高频环** (R=8-14)：对应图像的高频分量，对图像质量影响小
- **组合编码**：不同频段的值组合形成唯一密钥

**核心参数**：
- 编码半径范围：$R_{in}=3$ 到 $R_{out}=14$
- 频段数量：$11$ 个独立编码位
- 理论容量：$K^{11}$ 个不同密钥（$K=2$ 时为 $2048$ 个）

### 2.2 识别算法

给定待检测图像 $I$ 和 $N$ 个候选密钥 $\{K_1, K_2, ..., K_N\}$，识别过程如下：

1. 对图像进行 DDIM 逆向，获取潜在空间表示 $z$
2. 对 $z$ 进行 2D FFT，提取频域特征 $F(z)$
3. 计算与每个密钥模板的距离：$d_i = ||F(z) - T_{K_i}||_1$
4. 选择距离最小的密钥作为识别结果：$\hat{K} = \arg\min_i d_i$

---

## 3. 实验设计

### 3.1 基础识别实验

| 参数 | 值 | 说明 |
|------|-----|------|
| 密钥数量 | 5 | 模拟 5 家不同供应商 |
| 每密钥图片数 | 20 | 每个供应商生成 20 张图片 |
| 总图片数 | 100 | 5 × 20 = 100 |
| 图像分辨率 | 512×512 | 标准 SD 2.1 输出 |
| 推理步数 | 50 | DDIM 采样步数 |
| Prompt 来源 | Gustavosta/Stable-Diffusion-Prompts | 与团队成员对齐 |

### 3.2 密钥容量极限测试 🌟

**创新点**：系统性地探索密钥数量与识别准确率的关系。

| 密钥数量 | 测试图片数 | 每密钥图片数 |
|----------|------------|------------|
| 5 | 50 | 10 |
| 10 | 100 | 10 |
| 20 | 200 | 10 |
| 30 | 300 | 10 |
| 50 | 500 | 10 |

### 3.3 攻击场景

测试 7 种常见的图像攻击：

| 攻击类型 | 参数 | 实际场景 |
|----------|------|----------|
| Clean | - | 无攻击基线 |
| Rotation | 75° | 图像编辑旋转 |
| JPEG | Q=25 | 社交媒体压缩 |
| Crop & Scale | 75% | 截图后放大 |
| Gaussian Blur | r=8 | 模糊处理 |
| Gaussian Noise | σ=0.1 | 噪声干扰 |
| Brightness | [0,6] | 亮度调整 |

### 3.4 评估指标

**识别准确率 (Identification Accuracy)**：
$$\text{Acc} = \frac{\sum_{i=1}^{N} \mathbb{1}[\hat{K}_i = K_i^*]}{N}$$

**混淆矩阵 (Confusion Matrix)**：可视化密钥间的误识别模式

---

## 4. 实验结果

### 4.1 基础识别实验结果 (5 Key)

| 攻击类型 | 准确率 | 评价 |
|----------|--------|------|
| Clean | **100.0%** | ★★★★★ |
| Rotation 75° | **100.0%** | ★★★★★ |
| JPEG 25% | **100.0%** | ★★★★★ |
| Crop & Scale 75% | 90.0% | ★★★☆☆ |
| Gaussian Blur 8 | **100.0%** | ★★★★★ |
| Gaussian Noise 0.1 | **100.0%** | ★★★★★ |
| Brightness | 98.0% | ★★★★☆ |
| **平均** | **98.3%** | ★★★★★ |

**CLIP 质量评估**：
- 无水印图像 CLIP Score: 0.368
- 有水印图像 CLIP Score: 0.355
- 质量损失: **3.5%** (可忽略)

### 4.2 密钥容量极限测试结果 🌟

| 密钥数 | Clean | Rot75 | JPEG25 | C&S75 | Blur8 | Noise | Bright | **平均** |
|--------|-------|-------|--------|-------|-------|-------|--------|----------|
| **5** | 100% | 100% | 100% | 90.0% | 100% | 100% | 98.0% | **98.3%** |
| **10** | 100% | 100% | 100% | 78.0% | 100% | 100% | 97.0% | **96.4%** |
| **20** | 100% | 100% | 100% | 71.0% | 100% | 100% | 96.5% | **95.4%** |
| **30** | 100% | 99.7% | 100% | 58.3% | 100% | 98.7% | 97.0% | **93.4%** |
| **50** | 100% | 98.2% | 99.8% | 48.4% | 99.6% | 98.0% | 98.0% | **91.7%** |

**关键发现**：
- 密钥数量从 5 增加到 50，平均准确率从 98.3% 下降到 91.7%
- **裁剪缩放攻击是主要瓶颈**：从 90% 下降到 48.4%
- 其他攻击场景下，即使 50 个密钥仍保持 98%+ 准确率

### 4.3 容量-准确率曲线

![密钥容量-准确率曲线](../runs/key_capacity_test/key_capacity_curve.png)

**曲线分析**：
- **安全区** (5-20 Key)：平均准确率 > 95%，适合大多数应用场景
- **过渡区** (20-30 Key)：准确率开始明显下降，需权衡容量与准确率
- **风险区** (30+ Key)：裁剪缩放攻击下准确率低于 60%

---

## 5. 深入分析

### 5.1 密钥正交性分析

混淆矩阵显示密钥间具有良好的正交性：

```
              预测密钥
              K0    K1    K2    K3    K4
真实密钥 K0  [████]  [  ]  [  ]  [  ]  [  ]   98%
         K1  [  ]  [████]  [  ]  [  ]  [  ]   97%
         K2  [  ]  [  ]  [████]  [  ]  [  ]   99%
         K3  [  ]  [  ]  [  ]  [████]  [  ]   98%
         K4  [  ]  [  ]  [  ]  [  ]  [████]   99%
```

- **对角线元素**：平均 98.2%（正确识别）
- **非对角线元素**：平均 < 2%（误识别）
- **最大误识别对**：相邻密钥间的误识别率略高

### 5.2 攻击鲁棒性分析

| 攻击类型 | 鲁棒性 | 原因分析 |
|----------|--------|----------|
| JPEG 压缩 | ★★★★★ | 频域水印在低频区域，不受 DCT 压缩影响 |
| 旋转 | ★★★★★ | 环形结构具有旋转不变性 |
| 模糊/噪声 | ★★★★☆ | 低通滤波对环形区域影响有限 |
| 裁剪缩放 | ★★☆☆☆ | 破坏频域环形结构，导致信息丢失 |

### 5.3 频段解耦视角下的对比

| 特性 | Tree-Ring | RingID | 频段解耦视角 |
|------|-----------|--------|------------|
| 任务类型 | 二分类 | **多分类** | 多频段编码实现密钥区分 |
| 密钥容量 | 1 | **$K^{11}$** | 11 个频段的组合编码 |
| 频段利用 | 单一频段 | **多频段组合** | 与成员 A 的双频带策略互补 |
| 实用密钥数 | 1 | **20-30** | 频段容量的实际上限 |

---

## 6. 结论与建议

### 6.1 主要结论

1. **频段编码有效性**：基于 11 个频段的组合编码，在 5 密钥场景下达到 **98.3%** 识别准确率
2. **密钥正交性**：不同频段编码的密钥间干扰极小，误识别率低于 **2%**
3. **频段容量极限** 🌟：实用密钥容量为 **20-30** 个，超过此范围后频段间干扰增加
4. **与鲁棒性的关联**：裁剪缩放攻击破坏频域结构，是频段编码的主要瓶颈

### 6.2 应用建议

| 场景 | 建议密钥数 | 预期准确率 |
|------|------------|------------|
| 小型团队 (< 10 供应商) | 5-10 | > 96% |
| 中型平台 (10-20 供应商) | 10-20 | > 95% |
| 大型平台 (20+ 供应商) | 20-30 | > 93% |

### 6.3 与项目整体的关联

本研究与项目主题“基于频段解耦的生成式水印技术测评与优化”的关联：

| 维度 | 成员 A | 成员 B | 互补关系 |
|------|--------|--------|----------|
| 研究问题 | 频段选择对鲁棒性的影响 | 频段编码对可识别性的影响 | 鲁棒性 vs 可识别性 |
| 核心发现 | 双频带策略提升鲁棒性 | 多频段编码实现密钥区分 | 频段解耦的两个应用 |
| 局限性 | 高频水印抗攻击能力弱 | 频段容量有上限 | 共同的频域约束 |

### 6.4 局限性与未来工作

- **裁剪缩放攻击**：破坏频域环形结构，未来可探索多尺度频段编码
- **频段容量扩展**：可结合多通道编码进一步扩展密钥空间
- **与双频带策略结合**：探索在保证鲁棒性的同时最大化密钥容量

---

## 附录

### A. 实验环境

| 项目 | 配置 |
|------|------|
| GPU | NVIDIA RTX 4090 |
| 模型 | Stable Diffusion 2.1 Base |
| 推理框架 | PyTorch 1.13.0 + Diffusers 0.11.1 |
| 评估模型 | CLIP ViT-g-14 (laion2b_s12b_b42k) |

### B. 实验命令

```bash
# 基础识别实验
python identify.py \
    --run_name multi_key_5vendors_v2 \
    --trials 100 \
    --assigned_keys 5 \
    --save_generated_imgs 1 \
    --gpu_id 3

# 密钥容量测试
python scripts/key_capacity_test.py --keys 5,10,20,30,50 --gpu 3
```

### C. 数据对齐

- Prompt 来源：`Gustavosta/Stable-Diffusion-Prompts` 前 500 条
- 随机种子：`--general_seed 0`
- 对齐文件：`prompts_for_alignment.txt`
